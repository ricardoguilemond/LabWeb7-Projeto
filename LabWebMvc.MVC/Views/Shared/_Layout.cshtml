@using LabWebMvc.MVC.Areas.Utils
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@addTagHelper *, LabWebMvc.MVC.UtilHelper.MyTagHelpers
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>@((ViewData["TextoMenu"] as List<string>)?.FirstOrDefault() ?? "LabWeb7")</title>
    <meta name="description" content="" />
    <meta name="author" content="" />

    <!-- Bootstrap original padronizado para a aplicação em 27/03/2023 - Obrigatórios e nesta ordem!  -->
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.css" />

    <!-- JS para a aplicação -->
    <script src="~/js/jquery.min.js"></script>
    <!-- Exclusivo para o PopUp estilizado exibindo mensagens nas telas -->
    <script src="~/js/jquery.bpopup.min.js"></script>
    <!-- Para as máscaras de HTML usadas apenas nas exibições -->
    <script src="~/js/inputmask/jquery.inputmask.js"></script>
    <script src="~/js/jquery.maskedinput-1.4.1.min.js"></script>
    <!-- Outras máscara que preenchem moeda automaticamente -->
    <script src="~/js/jquery.maskMoney.min.js"></script>
    <!-- Para elaboração dos Charts JS-->
    @* <script scr="~/js/chart.min.js"></script> *@
    @* <script src="~/assets/demo/chart-area-demo.js"></script> *@

    <!-- SweetAlert2 -->
    <script src="~/js/sweetalert2.min.js"></script>
    <link rel="stylesheet" href="~/css/sweetalert2.min.css" />

    <!-- Meus CSS ::: esta lista de CSS sobrepõe classes com mesmo nomes anteriores -->
    <link href="~/css/styles.css" rel="stylesheet" /> <!-- obrigatoriamente antes do meu CSS abaixo -->
    <link href="~/css/site.css" rel="stylesheet" />

    @RenderSection("Head", required: false)

    <link href="~/css/mydatatables.css" rel="stylesheet" /><!-- para todos os datatables -->
    <!-- Fontes font-awesome ::: /fontawesome-free-6.2.0-web/css/all.min.css em 08/09-2022
         fontawesome.com/search?o=r&m=free&s=solid&f=classic
         https://fontawesome.com/v6/search?o=r&m=free
    -->
    <link href="~/fontawesome-free-6.2.0-web/css/all.min.css" rel="stylesheet" />

    <!-- Meus JS ::: DataTables em 08-09-2022 -->
    <link rel="stylesheet" href="~/DataTables/DataTables-2.0.8/datatables.min.css" />
    <script src="~/DataTables/DataTables-2.0.8/datatables.min.js" asp-append-version="false"></script>
    
    <!-- Obrigatório Meu JS (sempre no final) para poder renderizar junto com a página -->
    <script src="@Url.Content("~/js/site.js")" type="text/javascript"></script>

    <!-- STYLE REFERENTE AO LOADING DATATABLES DE TODAS AS PÁGINAS -->
    <style>
        #divEscondeMostra {
            transition: opacity 0.5s ease-in;
            opacity: 1;
        }

            #divEscondeMostra.hidden {
                opacity: 0;
                transition: none; /* esconde sem fade */
                display: none;
            }

            #divEscondeMostra.fading-in {
                display: block;
                opacity: 0;
            }

        .modalLoading {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 99;
            opacity: 0.8;
            --filter: alpha(opacity=80);
            --moz-opacity: 0.8;
            min-height: 100%;
            width: 100%;
            background-color: inherit;
        }
        /* Para todas as janelas de modal de mensagens/avisos */
        .modal { /* modal alterado somente para esta tela */
            width: 75%;
            margin-left: 15%;
        }

        .card-header {
            background-color: #e4e4e4;
        }

        .card-sombra {
            box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
        }

        .loading {
            width: 200px;
            height: 100px;
            display: none;
            position: fixed;
            z-index: 999;
            background-color: inherit;
        }

        .top-fixo {
            margin-top: -60px;
            margin-left: -30px;
        }
    </style>
</head>
<body class="sb-nav-fixed">
    <nav class="sb-topnav navbar navbar-expand navbar-dark bg-dark">
        <!-- Navbar Brand-->
        <a class="navbar-brand ps-3" href="#">Sistema Laboratorial</a>
        <!-- Sidebar Toggle-->
        <button class="btn btn-link btn-sm order-1 order-lg-0 me-4 me-lg-0" id="sidebarToggle" href="#!"><i class="fas fa-bars"></i></button>
        <!-- Navbar à direita com Login -->
        <ul class="navbar-nav ms-auto me-0 me-md-3 me-lg-4">
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" id="navbarDropdown" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="fas fa-user fa-fw"></i></a>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                    <li><a class="dropdown-item" href="#">Configurações</a></li>
                    <li><a class="dropdown-item" href="#">Atividades de Log</a></li>
                    <li><hr class="dropdown-divider" /></li>
                    <li><a class="dropdown-item" href="Home/Login">Login</a></li>
                    <li><a class="dropdown-item" href="Logout">Logout</a></li>
                </ul>
            </li>
        </ul>
    </nav>
    <div id="layoutSidenav">
        <div id="layoutSidenav_nav">
            <nav class="sb-sidenav accordion sb-sidenav-dark" id="sidenavAccordion">
                <div class="sb-sidenav-menu">
                    <div class="nav">
                        <div class="sb-sidenav-menu-heading">LabWeb7 2024</div>
                        <a class="nav-link" id="dashboard" href="#" onclick="func_Dashboard()">
                            <div class="sb-nav-link-icon"><i class="fas fa-tachometer-alt"></i></div>
                            Dashboard
                        </a>
                        @if (User?.Identity?.IsAuthenticated == true)  //Implementado no segundo login do HomeController
                        {
                            @await Component.InvokeAsync("MenuDinamico")
                        }
                    </div>
                </div>
                <div class="sb-sidenav-footer">
                    @await Component.InvokeAsync("ResumoUsuario")
                </div>
            </nav>
        </div>

        <!-- ÁREA PRINCIPAL / JORNAL DO SITE -->
        <div id="layoutSidenav_content">
            <div class="container-fluid px-4 mt-5">
                <div id="divEscondeMostra" class="mb-0">
                    <h3 style="color: #343a40;"><i class="fas fa-tachometer-alt"></i> Dashboard</h3>
                    <ol class="breadcrumb mb-4">
                        <li class="breadcrumb-item active"><i class="fas fa-table me-1"></i>Painel de eventos em linha de serviço</li>
                    </ol>
                    <!-- Início dos CARDS do Dashboard -->
                    <div class="row">
                        @await Html.PartialAsync("Dashboard/_CardServicosEspera")
                        @await Html.PartialAsync("Dashboard/_CardServicosAndamento")
                        @await Html.PartialAsync("Dashboard/_CardServicosConcluidos")
                        @await Html.PartialAsync("Dashboard/_CardServicosCriticos")
                    </div>
                    <!-- Área dos Charts -->
                    @* <div class="row">
                    <div class="col-xl-6">
                    <div class="card">
                    <div class="card-header">
                    <i class="fas fa-chart-area me-1"></i>
                    Area Chart Example
                    </div>
                    <div class="card-body"><canvas id="myAreaChart" width="100%" height="40"></canvas></div>
                    </div>
                    </div>
                    <div class="col-xl-6">
                    <div class="card">
                    <div class="card-header">
                    <i class="fas fa-chart-bar me-1"></i>
                    Bar Chart Example
                    </div>
                    <div class="card-body"><canvas id="myBarChart" width="100%" height="40"></canvas></div>
                    </div>
                    </div>
                    </div>
                    *@
                    <!-- Fim da área dos Charts -->
                    <!-- Placeholder para injetar modais via JS -->
                </div>
                <!-- LOADING EM TODAS AS PÁGINAS -->
                <div class="loading" align="center">
                    <img src="~/images/Diversos/carregando-black-palitos.gif" border='none' style="width: 32%;" />
                </div>
                <script type="text/javascript">
                    const card = document.createElement("div");
                    //..
                    (function () {
                        try {
                            document.addEventListener("DOMContentLoaded", function () {
                                var div = document.getElementById("divEscondeMostra");
                                var visible = localStorage.getItem("dashboardVisible");

                                if (div) {
                                    if (visible === "false") {
                                        div.classList.add("hidden");
                                    } else {
                                        div.classList.remove("hidden");
                                    }
                                }
                            });
                        } catch (e) {
                            console.warn("Erro ao acessar localStorage:", e);
                        }
                    })();

                    function func_Dashboard() {
                        const div = document.getElementById("divEscondeMostra");
                        if (!div) return;

                        const isHidden = div.classList.contains("hidden");

                        if (isHidden) {
                            // Mostrar com transição suave
                            div.classList.remove("hidden");
                            div.classList.add("fading-in");

                            // Força o reflow para que a transição funcione
                            void div.offsetWidth;

                            div.style.transition = "opacity 0.5s ease-in";
                            div.style.opacity = "1";

                            setTimeout(() => {
                                div.classList.remove("fading-in");
                            }, 500);

                            localStorage.setItem("dashboardVisible", true);
                        } else {
                            // Esconde imediatamente
                            div.classList.add("hidden");
                            div.style.transition = "none";
                            localStorage.setItem("dashboardVisible", false);
                        }
                    }
                    //..
                    var modalLoading, loading;
                    function ShowProgress() {
                        modalLoading = document.createElement("DIV");
                        modalLoading.className = "modalLoading";
                        document.body.appendChild(modalLoading);
                        loading = document.getElementsByClassName("loading")[0];
                        loading.style.display = "block";
                        /* Aqui, centraliza o loading na página */
                        var top = Math.max(window.innerHeight / 2 - loading.offsetHeight / 2, 0);
                        var left = Math.max(window.innerWidth / 2 - loading.offsetWidth / 2, 0);
                        loading.style.top = top + "px";
                        loading.style.left = left + "px";
                    };
                    ShowProgress();
                    //..
                </script>
                <!-- Fim do Loading -->
                <partial name="_CookieConsentPartial" />
                <div class="card mb-4 mt-2">
                    @{
                        var textoMenu = ViewBag.TextoMenu as object[] ?? new object[] { "LabWeb7", false };
                        var titulo = textoMenu.Length > 0 ? textoMenu[0]?.ToString() : "LabWeb7";
                    }
                    <div class="card-header">
                        <i class="fas fa-table me-1"></i>
                        <div style="display: inline-block; color: gray;">
                            Área de Trabalho: <span style="font-size: 1.0em; font-weight: 500;">@titulo</span>
                        </div>
                    </div>
                    <!-- Renderização criada automaticamente pelo Core ::: POSIÇÃO ÚNICA POSSÍVEL -->
                    @RenderBody()
                </div>
                <!-- para saltar uma linha e deixar um espaço e não cortar o DataTables ::: deveria ser uma solução provisória -->
                @*             
                    <div class="card mb-4 border-0">
                       <div class="card-header border-0" style="background-color: inherit;"></div>
                    </div>
                *@            
            </div>
        </div>
        <!-- Rodapé padrão do Core -->
        <footer class="border-top footer text-muted-white">
            <div class="container">
                &copy; 2006/@DateTime.Now.Year - Sistema LabWeb7 - Todos os Direitos Reservados -
                <a class="link-alternativo" asp-area="" asp-controller="Home" asp-action="Privacy">Nossa Política de Privacidade</a>
            </div>
        </footer>
        <div id="mypagedown"></div>
        <!-- Meus JS para a aplicação ::: Tem que vir sempre após todos JS oficiais acima -->
        <script src="~/js/site.js"></script>
        <script src="~/js/mydatatables.js"></script>

        <!-- Para o menu principal lateral esquerdo fazer os links funcionarem via "a href" -->
        <script src="~/js/bootstrap.bundle.min.js"></script>
        <script src="~/js/scripts.js"></script>

        <!-- ENCERRA O LOADING DE CARREGAMENTO DAS PÁGINAS -->
        <script type="text/javascript">
            window.onload = function () {
                setTimeout(function () {
                    document.body.removeChild(modalLoading);
                    loading.style.display = "none";
                }, 1000);
            };
        </script>
        <script>
            $(document).ready(function () {
                //-----------------------------------------------------------------------------------------------
                //Para saltar de campo em campo (somente input do type=text/TextBoxFor) nos formulários com ENTER
                //-----------------------------------------------------------------------------------------------
                $('body').on('keydown', 'input, select', function (e) {

                    //IGNORA campos de busca de DataTables (permite ENTER funcionar normalmente neles)
                    if ($('#modeloTableCompacta').closest($("input[type='search']")[0]).length > 0) {
                        console.log("Ignorando campo de busca do DataTable no _Layout");
                        return; // Não interfere
                    }
                    if (e.which === 13) {
                        var self = $(this),
                        form = self.parents('form:eq(0)'),
                        focusable,
                        next;

                        focusable = form.find('input[type=text], input[type=date], input[type=email], input[type=number], select').filter(':visible');
                        next = focusable.eq(focusable.index(this) + 1);

                        if (next.length) {
                            next.focus();
                        }

                        return false; // bloqueia envio automático do form
                    }
                });
                //..
            });
            // coloca seta estilizada em todos os botões de submit dos formulários que usam "button"
            document.addEventListener("DOMContentLoaded", function () {
                document.querySelectorAll('button[type="submit"]').forEach(button => {
                    if (!button.querySelector('.seta-gravacao')) {
                        const seta = document.createElement('span');
                        seta.classList.add('seta-gravacao');
                        button.appendChild(seta);
                    }
                });
            });
            //..
            //Permite o salvamento através de F5 em todas as páginas, pois aciona o clique do botão de submit
            document.addEventListener("keydown", function (event) {
                // Verifica se a tecla pressionada é F5
                if (event.key === "F5") {
                    event.preventDefault(); // Impede o reload da página

                    // Encontra o botão de submit e aciona o clique
                    const botaoSalvar = document.querySelector(".botao-verde");
                    if (botaoSalvar) {
                        botaoSalvar.click();
                    }
                }
            });
            //..
        </script>
        @RenderSection("Scripts", required: false)
    </div>
</body>
</html>
